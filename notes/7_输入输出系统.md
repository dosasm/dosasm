
# 第七章 输入/输出系统

## 7.1 概述

 **输入\输出系统** 是微型计算机系统中的主机与外部设备进行交互的系统。主机通过输入\输出接口与外部设备连接，在*接口电路*和*驱动程序*控制下进行信息交换。

:star:**接口**：是CPU与外部设备交换信息的中转站

接口电路的**功能**

- 应具有数据暂存/缓冲功能
- 与外设之间有联络功能，提供外设状态
- 应有端口地址编码器，具有寻址功能（便于`IN`,`OUT`指令读写数据）
- 有数据转换功能（并:arrow_right:串，串:arrow_right:并）
- 有中断管理能力

### 端口

:star:**端口**：是***接口电路***中，*能与CPU交换信息*（使用`IN`,`OUT`）的**寄存器**

**端口分类**：（接口电路必须具有数据口）[联系总线](######微型机的硬件结构)

- 数据口：存放CPU向外设输出或外设输入的数据
- 控制口：存放控制信息--控制接口电路、外设的工作
- 状态口：存放状态信息——反映外设的状态。

#### 端口编址方式

每个端口，系统都为它编一个地址，系统只要给出某个地址，通过译码电路，就能找到相应地I/O接口电路中的端口寄存器

:question:系统给出的地址是内存单元地址还是I/O端口寄存器的地址？

解决方案：合理安排I/O端口寄存器的**编址方式**：

- 存储器映像方式

  把端口寄存器和存储单元等同看待，**统一编址**。

  **特点**：凡访问存储单元的指令都可以访问I/O端口，端口地址占用存储空间

- I/O端口**独立编址**

  **特点**：I/O端口不占用存储空间，CPU要有专用的I/O指令

PC系列机采用**端口独立编址**

- 从8086到奔腾微处理器，设计时用A15~A0低16位地址寻址I/O端口，所以端口寻址能力为$2^{16}=65536$个
- 基于微处理器的PC系列，实际使用CPU中$A9\sim A0$做I/O地址线，所以，PC系列机I/O端口地址最多为$2^{10}=1024$个。这1024个口地址，系统本身(主板上, 以及常规 I/O接口)已经占用了一部分。
- 端口地址( I/O 空间)没有分段的概念。

### 最常用的I/O指令

#### 直接寻址I/O指令

设N为**8位**端口地址

```assembly
IN  AL,N  ;口地址为N的端口中取数给AL
OUT N, AL ;AL内容给口地址为N的端口寄存器
IN  AX,N  ;[N]->AL,[N+1]->AH
OUT N, AX ;AL->[N],AH->[N+1]
```

#### DX间址的I/O指令

当口地址N>8位二进制数时，用DX间址，但是书写时不能加方括号

```assembly
IN      AL,  DX   ;  [DX]的端口内容 → AL
OUT     DX,  AL   ;  AL →[DX]的端口寄存器
IN      AX,  DX   ;  [DX] → AL, [DX+1] → AH
OUT     DX,  AX   ;  AL → [DX], AH → [DX+1]
```

注意：I/O指令只能在端口和AL,AX,EAX之间交换信息，用DX间址，但不能使用方括号，即不能写成`IN AL,[DX]`

## 7.2 微型系统与外设交换信息的方式

微机系统与I/O端口的信息交换有四种方式：

1. 无条件传送
2. 查询方式
3. 中断方式
4. DMA方式：*DMA方式是说直接存储器存取方式（Direct Memory Access）。为实现DMA方式而设计的专用控制芯片，称为DMA控制器（DMAC）DMAC的HLDA为总线响应信号，HOLD为总线信号引脚*

采用何种方式与接口的硬件电路有直接关系

```asssembly
;无条件传送
;无条件传送方式进行数据读取时，可以使用指令：
  MOV DX, 201H
  IN AL, DX
;完成将201H端口中的8位数据读取到AL寄存器中。
;无条件传送方式进行数据输出时，使用指令：
  MOV DX, 201H
  MOV AL, 7FH
  OUT DX, AL
完成将AL寄存器中8位数据输出/写入到将201H端口中
;查询方式
;查询式外设数据输入核心程序如下：
RSCAN:   MOV DX,200H
         IN  AL,DX
         TEST AL,80H
         JZ  RSCAN
         MOV DX,201H
         IN  AL ,   DX
;查询式数据输出核心程序如下：
TSCAN:  MOV      DX,   200H
        IN           AL,    DX
        TEST     AL,  1
        JNZ       TSCAN
        MOV     DX,  200H
        MOV     AL,  某数
        OUT      DX,  AL
;设状态口地址为200H，数据口地址为201H，使用状态端口的最低位作为标志位(为0表示外设数据准备好)，请补全下面查询式输入程序。(每空2分，共6分)
RECAN:  MOV DX,200H
  IN AL,DX
  TEST AL,1
  JNZ RECAN
  MOV DX,201H
  IN AL,DX
```
